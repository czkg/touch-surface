<html>
<head>
    <script src="http://cdnjs.cloudflare.com/ajax/libs/d3/4.6.0/d3.min.js"></script>
    <script src="https://code.jquery.com/jquery-1.12.4.min.js"></script>
    <style>
        svg {
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -khtml-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }
    </style>
</head>
<style>
body {
    text-align: center;
    font-family: Sans-serif;
    margin: 0;
}
#canvas {
    background-color: black;
}
</style>
<body>
    <svg id="canvas" width="1280" height="800">

  <g transform="translate(85, 220)">
    <rect width="1110" height="450" style="fill-opacity:0;stroke-width:5;stroke:rgb(150,150,150)" />
  </g>
  
  <!-- first line -->
  <g transform="translate(95,230)" >
    <rect id="q_1_" x="0" y="0" width="100" height="100" rx="15" ry="15" style="fill:lightgrey"/>
    <text x="50" y="70" font-family="Verdana" font-size="65" text-anchor="middle">q</text><text x="80" y="50" font-family="Verdana" font-size="40" text-anchor="middle">1</text>
  </g>
   
  <g transform="translate(205,230)">
    <rect id="w_2_" x="0" y="0" width="100" height="100" rx="15" ry="15" style="fill:lightgrey"/>
    <text x="50" y="70" font-family="Verdana" font-size="65" text-anchor="middle">w</text><text x="80" y="50" font-family="Verdana" font-size="40" text-anchor="middle">2</text>
  </g>
  
  
  <g transform="translate(315,230)">
    <rect id="e_3_" x="0" y="0" width="100" height="100" rx="15" ry="15" style="fill:lightgrey"/>
    <text x="50" y="70" font-family="Verdana" font-size="65" text-anchor="middle">e</text><text x="80" y="50" font-family="Verdana" font-size="40" text-anchor="middle">3</text>
  </g>
  
  <g transform="translate(425,230)">
    <rect id="r_4_" x="0" y="0" width="100" height="100" rx="15" ry="15" style="fill:lightgrey"/>
    <text x="50" y="70" font-family="Verdana" font-size="65" text-anchor="middle">r</text><text x="80" y="50" font-family="Verdana" font-size="40" text-anchor="middle">4</text>
  </g>
  
  <g transform="translate(535,230)">
    <rect id="t_5_" x="0" y="0" width="100" height="100" rx="15" ry="15" style="fill:lightgrey"/>
    <text x="50" y="70" font-family="Verdana" font-size="65" text-anchor="middle">t</text><text x="80" y="50" font-family="Verdana" font-size="40" text-anchor="middle">5</text>
  </g>
  
  
  <g transform="translate(645,230)">
    <rect id="y_6_" x="0" y="0" width="100" height="100" rx="15" ry="15" style="fill:lightgrey"/>
    <text x="50" y="70" font-family="Verdana" font-size="65" text-anchor="middle">y</text><text x="80" y="50" font-family="Verdana" font-size="40" text-anchor="middle">6</text>
  </g>
  
  <g transform="translate(755,230)">
    <rect id="u_7_" x="0" y="0" width="100" height="100" rx="15" ry="15" style="fill:lightgrey"/>
    <text x="50" y="70" font-family="Verdana" font-size="65" text-anchor="middle">u</text><text x="80" y="50" font-family="Verdana" font-size="40" text-anchor="middle">7</text>
  </g>
  
  <g transform="translate(865,230)">
    <rect id="i_8_" x="0" y="0" width="100" height="100" rx="15" ry="15" style="fill:lightgrey"/>
    <text x="50" y="70" font-family="Verdana" font-size="65" text-anchor="middle">i</text><text x="80" y="50" font-family="Verdana" font-size="40" text-anchor="middle">8</text>
  </g>
  
  <g transform="translate(975,230)">
    <rect id="o_9_" x="0" y="0" width="100" height="100" rx="15" ry="15" style="fill:lightgrey"/>
    <text x="50" y="70" font-family="Verdana" font-size="65" text-anchor="middle">o</text><text x="80" y="50" font-family="Verdana" font-size="40" text-anchor="middle">9</text>
  </g>
  
  <g transform="translate(1085,230)">
    <rect id="p_0_" x="0" y="0" width="100" height="100" rx="15" ry="15" style="fill:lightgrey"/>
    <text x="50" y="70" font-family="Verdana" font-size="65" text-anchor="middle">p</text><text x="80" y="50" font-family="Verdana" font-size="40" text-anchor="middle">0</text>
  </g>
  
  <!-- second line -->
  
  <g transform="translate(150,340)">
    <rect id="a_'_" x="0" y="0" width="100" height="100" rx="15" ry="15" style="fill:lightgrey"/>
    <text x="50" y="70" font-family="Verdana" font-size="65" text-anchor="middle">a</text><text x="80" y="50" font-family="Verdana" font-size="40" text-anchor="middle">'</text>
  </g>
  
  <g transform="translate(260,340)">
    <rect id="s_:_" x="0" y="0" width="100" height="100" rx="15" ry="15" style="fill:lightgrey"/>
    <text x="50" y="70" font-family="Verdana" font-size="65" text-anchor="middle">s</text><text x="80" y="50" font-family="Verdana" font-size="40" text-anchor="middle">:</text>
  </g>
  
  <g transform="translate(370,340)">
    <rect id="d_>_" x="0" y="0" width="100" height="100" rx="15" ry="15" style="fill:lightgrey"/>
    <text x="50" y="70" font-family="Verdana" font-size="65" text-anchor="middle">d</text><text x="80" y="50" font-family="Verdana" font-size="40" text-anchor="middle"> > </text>
  </g>
  
  <g transform="translate(480,340)">
    <rect id="f_<_" x="0" y="0" width="100" height="100" rx="15" ry="15" style="fill:lightgrey"/>
    <text x="50" y="70" font-family="Verdana" font-size="65" text-anchor="middle">f</text><text x="80" y="50" font-family="Verdana" font-size="40" text-anchor="middle"> < </text>
  </g>
  
  <g transform="translate(590,340)">
    <rect id="g_?_" x="0" y="0" width="100" height="100" rx="15" ry="15" style="fill:lightgrey"/>
    <text x="50" y="70" font-family="Verdana" font-size="65" text-anchor="middle">g</text><text x="80" y="50" font-family="Verdana" font-size="40" text-anchor="middle">?</text>
  </g>
  
  <g transform="translate(700,340)">
    <rect id="h_;_" x="0" y="0" width="100" height="100" rx="15" ry="15" style="fill:lightgrey"/>
    <text x="50" y="70" font-family="Verdana" font-size="65" text-anchor="middle">h</text><text x="80" y="50" font-family="Verdana" font-size="40" text-anchor="middle">;</text>
  </g>
  
  <g transform="translate(810,340)">
    <rect id="j_/_" x="0" y="0" width="100" height="100" rx="15" ry="15" style="fill:lightgrey"/>
    <text x="50" y="70" font-family="Verdana" font-size="65" text-anchor="middle">j</text><text x="80" y="50" font-family="Verdana" font-size="40" text-anchor="middle">/</text>
  </g>
  
  <g transform="translate(920,340)">
    <rect id="k_,_" x="0" y="0" width="100" height="100" rx="15" ry="15" style="fill:lightgrey"/>
    <text x="50" y="70" font-family="Verdana" font-size="65" text-anchor="middle">k</text><text x="80" y="50" font-family="Verdana" font-size="40" text-anchor="middle">,</text>
  </g>
  
  <g transform="translate(1030,340)">
    <rect id="l_._" x="0" y="0" width="100" height="100" rx="15" ry="15" style="fill:lightgrey"/>
    <text x="50" y="70" font-family="Verdana" font-size="65" text-anchor="middle">l</text><text x="80" y="50" font-family="Verdana" font-size="40" text-anchor="middle">.</text>
  </g>
 
  
  <!-- Third line -->
  <!-- <g transform="translate(95,450)">
    <rect id="shift" x="0" y="0" width="130" height="100" rx="15" ry="15" style="fill:lightgrey"/>
    <text x="65" y="70" font-family="Verdana" font-size="65" text-anchor="middle">&#8679</text>
  </g> -->
  
  <g transform="translate(260,450)">
    <rect id="z_-_" x="0" y="0" width="100" height="100" rx="15" ry="15" style="fill:lightgrey"/>
    <text x="50" y="70" font-family="Verdana" font-size="65" text-anchor="middle">z</text><text x="80" y="50" font-family="Verdana" font-size="40" text-anchor="middle">-</text>
  </g>
  
  <g transform="translate(370,450)">
    <rect id="x_(_" x="0" y="0" width="100" height="100" rx="15" ry="15" style="fill:lightgrey"/>
    <text x="50" y="70" font-family="Verdana" font-size="65" text-anchor="middle">x</text><text x="80" y="50" font-family="Verdana" font-size="40" text-anchor="middle">(</text>
  </g>
  
  <g transform="translate(480,450)">
    <rect id="c_)_" x="0" y="0" width="100" height="100" rx="15" ry="15" style="fill:lightgrey"/>
    <text x="50" y="70" font-family="Verdana" font-size="65" text-anchor="middle">c</text><text x="80" y="50" font-family="Verdana" font-size="40" text-anchor="middle">)</text>
  </g>
  
  <g transform="translate(590,450)">
    <rect id="v_*_" x="0" y="0" width="100" height="100" rx="15" ry="15" style="fill:lightgrey"/>
    <text x="50" y="70" font-family="Verdana" font-size="65" text-anchor="middle">v</text><text x="80" y="50" font-family="Verdana" font-size="40" text-anchor="middle">*</text>
  </g>
  
  <g transform="translate(700,450)">
    <rect id="b_&_" x="0" y="0" width="100" height="100" rx="15" ry="15" style="fill:lightgrey"/>
    <text x="50" y="70" font-family="Verdana" font-size="65" text-anchor="middle">b</text><text x="80" y="50" font-family="Verdana" font-size="40" text-anchor="middle"> & </text>
  </g>
  
  <g transform="translate(810,450)">
    <rect id="n_^_" x="0" y="0" width="100" height="100" rx="15" ry="15" style="fill:lightgrey"/>
    <text x="50" y="70" font-family="Verdana" font-size="65" text-anchor="middle">n</text><text x="80" y="50" font-family="Verdana" font-size="40" text-anchor="middle">^</text>
  </g>
  
  <g transform="translate(920,450)">
    <rect id="m_@_" x="0" y="0" width="100" height="100" rx="15" ry="15" style="fill:lightgrey"/>
    <text x="50" y="70" font-family="Verdana" font-size="65" text-anchor="middle">m</text><text x="80" y="40" font-family="Verdana" font-size="30" text-anchor="middle">@</text>
  </g>
  
  <g transform="translate(1055,450)">
    <rect id="back" x="0" y="0" width="130" height="100" rx="15" ry="15" style="fill:lightgrey"/>
    <text x="65" y="70" font-family="Verdana" font-size="65" text-anchor="middle">&#8678</text>
  </g>
  
  <!-- forth line -->
  <g transform="translate(370,560)">
    <rect id="space" x="0" y="0" width="540" height="100" rx="15" ry="15" style="fill:lightgrey"/>
    <text x="270" y="70" font-family="Verdana" font-size="65" text-anchor="middle">space</text>
  </g>
  
  <g transform="translate(920,560)">
    <rect id="enter" x="0" y="0" width="265" height="100" rx="15" ry="15" style="fill:lightgrey"/>
    <text x="132.5" y="70" font-family="Verdana" font-size="65" text-anchor="middle">enter</text>
  </g>

  <!-- type area -->
  <g transform="translate(5,5)">
    <rect id="area" width="1270" height="200" style="fill-opacity:0;stroke-width:5;stroke:rgb(150,150,150)" />
  </g>

  <g>
    <text id="type0" x="25" y="60" font-family="Verdana" font-size="65" text-anchor="start" style="fill:lightgrey"></text>
  </g>

  <g>
    <text id="type1" x="25" y="125" font-family="Verdana" font-size="65" text-anchor="start" style="fill:lightgrey"></text>
  </g>

  <g>
    <text id="type2" x="25" y="190" font-family="Verdana" font-size="65" text-anchor="start" style="fill:lightgrey"></text>
  </g>

 <!--  <g>
    <text id="type3" x="25" y="255" font-family="Verdana" font-size="65" text-anchor="start" style="fill:lightgrey"></text>
  </g>

  <g>
    <text id="type4" x="25" y="320" font-family="Verdana" font-size="65" text-anchor="start" style="fill:lightgrey"></text>
  </g> -->

    </svg>

    <script>
    function WebSocketRun() {
        var canvas = d3.select("#canvas");
        var colors = ["red", "blue", "yellow", "green", "purple", "white"];
        var alltexts = new Array(3);
        alltexts.fill("");
        var currentRow = 0;
        var textname = "text#type";
        var totalWidth = 1180;
        var isShift = false;
        var isShow = false;
        var isRecord = false;
        var isRecordLast = false;

        document.addEventListener("keydown", (event) => {
          if(event.keyCode == 82) {
            isRecord = !isRecord;
          }
        })

        setInterval(function(){
          isShow = !isShow;
          if(isShow) {
            alltexts[currentRow] += "|";
          }
          else {
            alltexts[currentRow] = alltexts[currentRow].slice(0, -1);
          }
          for(idx = 0; idx < 3; idx++) {
            var selector = textname + idx.toString().trim();
            d3.select(selector).text(alltexts[idx]);
          }
        }, 1000);

        function holdBack(x, y) {
          d3.selectAll("g").each(function() {
            var bbox = this.getBoundingClientRect();
            if(x > bbox.left && x < bbox.right &&
               y > bbox.top && y < bbox.bottom) {
              if(d3.select(this).select("rect").attr('id') == "back") {
                findContainingKey(x, y);
              }
            }
          });
        }

        function findContainingKey(px, py, x, y, finger, state) {
            d3.selectAll("g").each(function() {
                var bbox = this.getBoundingClientRect();
                if (x > bbox.left && x < bbox.right &&
                    y > bbox.top && y < bbox.bottom) {
                    if(finger == "3") {
                      d3.select(this)
                      .select("rect")
                      .style("fill","green");
                    }
                    else if(finger == "4") {
                      d3.select(this)
                      .select("rect")
                      .style("fill","blue");
                    }
                    else {
                      d3.select(this)
                      .select("rect")
                      .style("fill","red");
                    }
                    var val = d3.select(this).text();
                    var id = d3.select(this).select("rect").attr("id");
                    if(id == null) {
                      return;
                    }
                    val = val.trim();
                    var lineval;

                    if(isShow) {
                      alltexts[currentRow] = alltexts[currentRow].slice(0, -1);
                    }

                    if(val == "space") {
                        val = " ";
                    }
                    if(id == 'shift') {
                      val = "";
                      isShift = !isShift;
                    }
                    if(val == "enter") {
                        val = "";
                        if(currentRow < 2) {
                            currentRow++;
                        }
                    }
                    if(id == "back") {
                        val = "";
                        if(alltexts[currentRow].length > 0) {
                            alltexts[currentRow] = alltexts[currentRow].slice(0, -1);
                        }
                        else {
                            if(currentRow != 0) {
                                currentRow--;
                                alltexts[currentRow] = alltexts[currentRow].slice(0, -1);
                            }
                        }
                    }
                    //console.log(finger)
                    if(id.endsWith("_")) {
                      if(finger == "3") {
                        val = id.substr(2, 1);
                      }
                      else {
                        val = id.substr(0, 1);
                      }
                    }
                    if(val != "" && val != " " && finger == "4") {
                      val = val.toUpperCase();
                    }
                    var selector = textname + currentRow.toString().trim();
                    var currentWidth;
                    try {
                        currentWidth = d3.select(selector).node().getComputedTextLength();
                    }
                    catch (e) {
                        currentWidth = 0;

                    }
                    if(currentWidth > totalWidth && currentRow < 2) {
                        currentRow++;
                        currentWidth = 0;
                    }
                    if(currentWidth < totalWidth) {
                        alltexts[currentRow] += val;
                    }
                    if(isShow) {
                      alltexts[currentRow] += "|";
                    }
                    var idx;
                    for(idx = 0; idx <= currentRow; idx++) {
                        selector = textname + idx.toString().trim();
                        d3.select(selector).text(alltexts[idx]);
                    }

                    //send data to writeFiles
                    if(isRecord) {
                      var time = Math.round(new Date().getTime() / 1000);
                      $.ajax({
                        url: "http://127.0.0.1:5000",
                        type: "POST",
                        data: {'key': id,
                               'time': time,
                               'px' : px,
                               'py' : py,
                               'ex' : x, 
                               'ey' : y,
                               'finger' : finger,
                               'state' : state,
                               'isRecordLast' : isRecordLast},
                      });
                    }
                    isRecordLast = isRecord;
                }
            });
        }


        if ("WebSocket" in window) {
            console.log("WebSocket is supported by your Browser!");

            // Let us open a web socket
            var ws = new WebSocket("ws://localhost:9002/");

            ws.onopen = function()
            {
                // Web Socket is connected, send data using send()
            };

            ws.onmessage = function (evt)
            {
                var receivedTouches = $.parseJSON(evt.data);
                // console.log(receivedTouches);

                // canvas.selectAll(".touch-point").remove();
                if (receivedTouches == null) {
                    d3.selectAll("g").each(function() {
                        d3.select(this)
                        .select("rect")
                        .style("fill","lightgrey");
                        // d3.select("rect.rectdis").remove();
                        // d3.select("text.textdis").remove();
                    });
                    if(isShift) {
                      d3.select("rect#shift").style("fill", "red");
                    }
                    return;
                }

                receivedTouches.forEach((e)=>{
                    // canvas.append("circle")
                    //     .classed("touch-point", true)
                    //     .attr("cx", e.x)
                    //     .attr("cy", e.y)
                    //     .attr("r", 20)
                    //     .style("fill", colors[e.finger]);

                    // canvas.append("rect")
                    //     .classed("rectdis", true)
                    //     .attr("x", 60)
                    //     .attr("y", 490)
                    //     .attr("width", 150)
                    //     .attr("height", 100)
                    //     .attr("stroke", "white")
                    //     .attr("stroke-width", 5)
                    //     .attr("fill-opacity", 0);
                    // canvas.append("text")
                    //     .classed("textdis", true)
                    //     .attr("x", 35)
                    //     .attr("y", 25)
                    //     .style("fill", "lightgrey")
                    //     .style("font-size", "40px")
                    //     .style("text-anchor", "start")
                    if(e.state == 0) {
                      findContainingKey(e.px, e.py, e.ex, e.ey, e.finger, e.state);
                    }
                    else if(e.state != 3 && isShift) {
                      holdBack(e.ex, e.ey);
                    }
                });
            };

            ws.onclose = function()
            {
                // websocket is closed.
                console.log("Connection is closed...");
            };
        } else {
            // The browser doesn't support WebSocket
            alert("WebSocket NOT supported by your Browser!");
        }
    }

    $(()=>{
        WebSocketRun();
        // Size canvas
        const svg = d3.select('#canvas')
                      .attr('width', 1280)  // extra width space
                      .attr('height', 800)
                      .attr('viewBox', '0 0 1280 800');

    });
    </script>
</body>
</html>
